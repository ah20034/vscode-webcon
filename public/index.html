<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebCon Demo</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 2rem; line-height: 1.6; }
    a { color: #0b5fdf; }
    header { display: flex; align-items: baseline; gap: .75rem; }
    header h1 { margin: 0; }
    ul { margin-top: 1rem; }
    code { background: #f5f5f5; padding: 0.2rem 0.4rem; border-radius: 4px; }
    .row { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    .hint { opacity:.8; }
    #qrOverlay { position: absolute; inset: 0; pointer-events: none; }
    #qrBox { position: relative; display:inline-block; }
  </style>
</head>
<body>
  <header>
    <h1>WebCon サンプル</h1>
    <small>Express + A-Frame + AR.js</small>
  </header>
  <hr />

  <section>
    <h2>カメラをこのページで起動して表示</h2>
    <p>HTTPS（または localhost）でのみ動作します。初回はカメラの使用許可が求められます。</p>
    <div class="row">
      <button id="startCam">カメラ起動</button>
      <button id="stopCam" disabled>停止</button>
      <span id="camStatus" style="opacity:.8;">待機中</span>
    </div>
    <div id="qrBox" style="margin-top:.75rem;">
      <video id="preview" playsinline autoplay muted style="width:min(720px,95vw); background:#000; border-radius:.5rem;"></video>
      <canvas id="qrOverlay"></canvas>
    </div>
    <div class="row" style="margin-top:.5rem;">
      <button id="startQR" disabled>QRスキャン開始</button>
      <button id="stopQR" disabled>QR停止</button>
      <span class="hint">結果: <code id="qrResult">-</code></span>
    </div>
  </section>

  <!-- jsQR CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <script>
  const startBtn = document.getElementById('startCam');
  const stopBtn = document.getElementById('stopCam');
  const statusEl = document.getElementById('camStatus');
  const videoEl = document.getElementById('preview');
  const overlay = document.getElementById('qrOverlay');
  const startQR = document.getElementById('startQR');
  const stopQR = document.getElementById('stopQR');
  const qrResultEl = document.getElementById('qrResult');
  let stream = null;
  let qrRAF = null;
  let scanning = false;
  let scanCaptured = false; // このスキャンセッションでQRを1度だけ確定

  function setStatus(s){ statusEl.textContent = s; }

  startBtn.addEventListener('click', async () => {
    try {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('このブラウザはカメラ API に対応していません。');
        return;
      }
      setStatus('権限確認中…');
      startBtn.disabled = true;
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' } },
        audio: false
      });
      videoEl.srcObject = stream;
      setStatus('映像取得中');
      stopBtn.disabled = false;
      // QRボタン有効化
      startQR.disabled = false;
    } catch (e) {
      console.error(e);
      setStatus('起動失敗: ' + (e && e.name || 'Unknown'));
      alert('カメラが起動できません。権限設定（ブロック→許可に変更）や、他アプリが使用中でないか確認してください。');
      startBtn.disabled = false;
    }
  });

  stopBtn.addEventListener('click', () => {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
      videoEl.srcObject = null;
      setStatus('停止しました');
      stopBtn.disabled = true;
      startBtn.disabled = false;
      // QR停止
      scanning = false;
      startQR.disabled = true;
      stopQR.disabled = true;
      if (qrRAF) { cancelAnimationFrame(qrRAF); qrRAF = null; }
    }
  });

  function drawOverlayLine(ctx, begin, end, color) {
    ctx.beginPath();
    ctx.moveTo(begin.x, begin.y);
    ctx.lineTo(end.x, end.y);
    ctx.lineWidth = 4;
    ctx.strokeStyle = color;
    ctx.stroke();
  }

  function scanLoop() {
    if (!scanning || !videoEl || videoEl.readyState < 2) {
      qrRAF = requestAnimationFrame(scanLoop);
      return;
    }
    const rect = videoEl.getBoundingClientRect();
    overlay.width = rect.width;
    overlay.height = rect.height;
    const ctx = overlay.getContext('2d');
    ctx.drawImage(videoEl, 0, 0, overlay.width, overlay.height);
    const imageData = ctx.getImageData(0, 0, overlay.width, overlay.height);
    const qr = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'dontInvert' });
    ctx.clearRect(0, 0, overlay.width, overlay.height);
    if (qr) {
      drawOverlayLine(ctx, qr.location.topLeftCorner, qr.location.topRightCorner, '#00ff88');
      drawOverlayLine(ctx, qr.location.topRightCorner, qr.location.bottomRightCorner, '#00ff88');
      drawOverlayLine(ctx, qr.location.bottomRightCorner, qr.location.bottomLeftCorner, '#00ff88');
      drawOverlayLine(ctx, qr.location.bottomLeftCorner, qr.location.topLeftCorner, '#00ff88');
      qrResultEl.textContent = qr.data;

     // 初回検出時に確定し、位置情報を取得するイベントを発火
     if (!scanCaptured) {
       scanCaptured = true;
       // スキャンを停止（プレビューは継続）
       scanning = false;
       if (qrRAF) { cancelAnimationFrame(qrRAF); qrRAF = null; }
       startQR.disabled = false;
       stopQR.disabled = true;
       // 位置情報をリクエスト（位置セクションが処理）
       document.dispatchEvent(new CustomEvent('request-geo', {
         detail: { qrData: qr.data, when: Date.now() }
       }));
     }
    }
    qrRAF = requestAnimationFrame(scanLoop);
  }

  startQR.addEventListener('click', () => {
    scanning = true;
   scanCaptured = false; // 新しいスキャンセッション開始
    startQR.disabled = true;
    stopQR.disabled = false;
    qrResultEl.textContent = '-';
    if (!qrRAF) qrRAF = requestAnimationFrame(scanLoop);
  });

  stopQR.addEventListener('click', () => {
    scanning = false;
    startQR.disabled = false;
    stopQR.disabled = true;
    if (qrRAF) { cancelAnimationFrame(qrRAF); qrRAF = null; }
    const ctx = overlay.getContext('2d');
    ctx && ctx.clearRect(0, 0, overlay.width, overlay.height);
  });
  </script>

  <!-- 位置情報セクション -->
  <section id="geo-section" style="margin-top:2rem; padding:1rem; border:1px solid #ddd; border-radius:8px;">
    <h2>位置情報</h2>
    <p id="geo-status">未取得</p>
    <div class="row" style="gap:.5rem;">
      <button id="geo-request">現在地を取得</button>
      <button id="geo-watch">追跡開始</button>
      <button id="geo-stop" disabled>停止</button>
    </div>
    <ul style="margin-top:.5rem;">
      <li>緯度: <span id="lat">-</span></li>
      <li>経度: <span id="lng">-</span></li>
      <li>精度: <span id="acc">-</span> m</li>
      <li>取得時刻: <span id="ts">-</span></li>
    </ul>
  </section>

  <script>
  (() => {
    const statusEl = document.getElementById('geo-status');
    const btnReq   = document.getElementById('geo-request');
    const btnWatch = document.getElementById('geo-watch');
    const btnStop  = document.getElementById('geo-stop');
    const latEl = document.getElementById('lat');
    const lngEl = document.getElementById('lng');
    const accEl = document.getElementById('acc');
    const tsEl  = document.getElementById('ts');
    let watchId = null;

    const setG = (msg) => statusEl.textContent = msg;

    if (!('geolocation' in navigator)) {
      setG('このブラウザは位置情報に未対応');
      btnReq.disabled = true; btnWatch.disabled = true; btnStop.disabled = true;
      return;
    }
    if (!window.isSecureContext) {
      setG('HTTPS以外（localhost除く）では位置情報が制限されます');
    }

    // 権限状態（対応ブラウザのみ）
    if (navigator.permissions?.query) {
      navigator.permissions.query({ name: 'geolocation' })
        .then(p => {
          setG(`権限: ${p.state}`);
          p.onchange = () => setG(`権限: ${p.state}`);
        })
        .catch(() => {});
    }

    const opts = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };

    const onPos = (pos) => {
      const { latitude, longitude, accuracy } = pos.coords;
      latEl.textContent = latitude.toFixed(6);
      lngEl.textContent = longitude.toFixed(6);
      accEl.textContent = Math.round(accuracy);
      tsEl.textContent  = new Date(pos.timestamp).toLocaleString();
      setG('取得成功');
      // TODO: 必要ならここでQR内容と合わせてサーバーに送信
    };

    const onErr = (err) => {
      setG(`エラー(${err.code}): ${err.message}`);
    };

    btnReq.addEventListener('click', () => {
      setG('現在地を取得中...');
      navigator.geolocation.getCurrentPosition(onPos, onErr, opts);
    });

    btnWatch.addEventListener('click', () => {
      if (watchId !== null) return;
      setG('追跡中...');
      watchId = navigator.geolocation.watchPosition(onPos, onErr, opts);
      btnWatch.disabled = true;
      btnStop.disabled  = false;
    });

    btnStop.addEventListener('click', () => {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        setG('追跡停止');
        btnWatch.disabled = false;
        btnStop.disabled  = true;
      }
    });

   // QR検出時に1回だけ現在地を取得（イベントで連携）
   document.addEventListener('request-geo', (e) => {
     setG('QR検出→位置取得中...');
     navigator.geolocation.getCurrentPosition(onPos, onErr, opts);
   });
  })();
  </script>
</body>
</html>
